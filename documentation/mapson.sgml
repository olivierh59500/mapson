<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V4.1//EN" [
<!ENTITY mapson "<application>mapSoN</application>">
<!ENTITY description SYSTEM "description.sgml">
<!ENTITY building SYSTEM "building.sgml">
<!ENTITY license SYSTEM "license.sgml">
<!ENTITY defconfig SYSTEM "defconfig.sgml">
<!ENTITY defreqmail SYSTEM "defreqmail.sgml">
]>

<article>
  <articleinfo>
    <title>&mapson; User Manual</title>
    <author>
      <firstname>Peter</firstname>
      <surname>Simons</surname>
      <affiliation>
        <address><email>simons@computer.org</email></address>
      </affiliation>
    </author>
  </articleinfo>

  <sect1>
    <title>Introduction</title>

    &description;

    <para>This manual describes how to compile, install, and configure &mapson;
in various setups.</para>
  </sect1>

  <sect1>
    <title>Building &mapson;</title>
    &building;
  </sect1>

  <sect1>
    <title>The &mapson; configuration file</title>

    <para>

  </sect1>

  <sect1>
    <title>The request for confirmation file</title>

    <para>The request-for-confirmation mail is created by loading the configured
template file and exanding the variables contained in it. The result is then
piped into the command, you have configured as <varname>MTA</varname>.</para>

    <para>The following variables are provided in the request-for-confirmation
mail template file:</para>

    <variablelist>
      <varlistentry>
        <term><varname>md5hash</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>envelope</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>sender</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>return_path</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>header</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>body</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><varname>messageid</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>
    </variablelist>

    <para>In addition to those, the following arrays are provided:</para>

    <variablelist>
      <varlistentry>
        <term><varname>headerlines[]</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>
    </variablelist>

    <variablelist>
      <varlistentry>
        <term><varname>header[]</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>
    </variablelist>

    <variablelist>
      <varlistentry>
        <term><varname>body[]</varname></term>
        <listitem>
          <para></para>
        </listitem>
      </varlistentry>
    </variablelist>

  </sect1>

  <sect1>
    <title>Setting &mapson; up</title>

    <sect2>
      <title>Via <filename>.forward</filename></title>

      <blockquote>
        <programlisting>"|exec <replaceable>/usr/local/bin/mapson</replaceable>"</programlisting>
      </blockquote>
    </sect2>

    <sect2>
      <title>Via <filename>.procmailrc</filename></title>

      <blockquote>
        <programlisting># Pipe anything, that is not a reply or comes from a mailing
# list, into mapson for approval.
#
:0 w
* !^(In-Reply-To|References|Message-Id):.*<replaceable>example.com</replaceable>
* !^Precedence: (list|bulk|junk)
* !^Auto-Submitted:
| <replaceable>/usr/local/mapson/bin/mapson</replaceable></programlisting>
      </blockquote>

      <sect3>
        <title>Getting a notification in case of failure</title>

      <para>You might want to add the recipt

        <blockquote>
          <programlisting>:0 ec
| /usr/bin/sed -e 's/^/ | /' | \
/bin/mail -s "mapSoN failed on this mail" <replaceable>postmaster</replaceable></programlisting>
        </blockquote>

directly after the &mapson; call. This action will only be executed if the
previous repict failed with an error, and will send a notification of the fact
that mapson failed to <systemitem class="username">postmaster</systemitem> or
whoever is responsible for the mail system on your site.</para>

      <para>Adding this recipt is <emphasis>not</emphasis> a good idea, though,
if you're letting &mapson; fail for mails that have syntax errors!</para>
      </sect3>

      <sect3>
        <title>Using <application>procmail</application>`s "argument"
feature</title>

        <blockquote>
          <programlisting>ARGUMENT="$1"

# An argument of 'failsafe' will always by-pass all other
# rules to make sure that I have a reliably working address
# no matter what happens here.
#
:0
* ARGUMENT ?? failsafe
$DEFAULT

# Confirmation mails go into mapSoN.
# Note: Not all systems support that regular expression syntax!
#
:0
* ARGUMENT ?? [a-f0-9]{32}
| <replaceable>/usr/local/mapson/bin/mapson</replaceable>
:0 ec

# Anything that has such an argument is probably coming from
# a mailing list and should not go through mapSoN.
#
:0
* ARGUMENT ?? ..*
$DEFAULT</programlisting>
        </blockquote>
      </sect3>
    </sect2>
  </sect1>

  <sect1>
    <title>Expiring the mail spool</title>

    <para>
  </sect1>

  <appendix>
    <title>License</title>

    &license;
  </appendix>

  <appendix>
    <title>The default configuration</title>
    <programlisting>&defconfig;</programlisting>
  </appendix>

  <appendix>
    <title>An example request-for-confirmation template</title>
    <programlisting>&defreqmail;</programlisting>
  </appendix>

</article>
